# Subscriptions & Cross-System Data Architecture

## Overview

The hosting ecosystem consists of three systems with separate databases:

- **Hosting platform** — source of truth for infrastructure (tenants, webroots, databases, email, DNS, etc.)
- **Control panel** — customer-facing UI; owns access control (customers, users, permissions)
- **CRM** (future) — commercial layer; owns products, pricing, orders, invoices

Subscriptions are a thin grouping layer in the hosting platform that serves as the integration seam between all three systems. A subscription groups related resources within a tenant (e.g., "a web hosting package" containing a webroot, databases, email accounts, and a DNS zone).

## Design Principles

1. **No resource data sync.** The control panel and CRM never store copies of resource data. They hold subscription/tenant IDs and query the hosting API at request time.
2. **Single source of truth per domain.** Hosting platform owns infrastructure, CRM owns commercial data, control panel owns access control.
3. **Subscription as the integration seam.** All three systems reference the same subscription UUID. No mapping tables, no external ID columns.

## Data Model

### Hosting Platform

Add a `subscriptions` table:

```sql
CREATE TABLE subscriptions (
    id         TEXT PRIMARY KEY,  -- UUID, provided by the caller (CRM)
    tenant_id  TEXT NOT NULL REFERENCES tenants(id),
    name       TEXT NOT NULL,
    status     TEXT NOT NULL DEFAULT 'pending',
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

Add a NOT NULL `subscription_id` column to all resource tables (`webroots`, `databases`, `email_accounts`, `zones`, etc.):

```sql
ALTER TABLE webroots ADD COLUMN subscription_id TEXT NOT NULL REFERENCES subscriptions(id);
-- same for databases, email_accounts, zones, etc.
```

Every resource must belong to a subscription. No orphaned resources.

### Control Panel

No subscription data stored. The control panel maps customers → tenants and queries the hosting API for subscriptions and their resources at request time.

Existing tables remain: `customers`, `customer_users`, `customer_tenants`.

### CRM

The CRM stores the commercial side:

- **Products/plans** — features, limits, pricing
- **Orders/contracts** — links a customer to a product, holds the `subscription_id`
- **Invoices, payments** — billing lifecycle

The `subscription_id` on an order is the same UUID that exists in the hosting platform's `subscriptions` table.

## Subscription Lifecycle

The CRM generates the subscription UUID. The hosting platform accepts it on provisioning.

### Order via webshop

1. Customer places order → CRM creates order with `subscription_id = <new UUID>`, status pending
2. Payment confirmed → CRM calls hosting API: `POST /tenants/{id}/subscriptions` with the pre-generated UUID
3. Hosting platform creates the subscription and provisions resources within it
4. CRM marks order as fulfilled

### Order via control panel

1. User clicks "add subscription" → control panel sends request to CRM
2. CRM creates order with `subscription_id = <new UUID>`
3. Same fulfillment flow as above

The control panel never creates subscriptions directly — it always goes through the CRM so every subscription has a corresponding commercial record.

### Idempotency

Since the UUID is generated before the hosting API call, retries on provisioning failure naturally avoid duplicates. The hosting API should accept the client-provided ID and return a conflict if it already exists.

## API Changes Required

### Hosting Platform

- `POST /tenants/{id}/subscriptions` — create subscription (accepts client-provided `id` in body)
- `GET /tenants/{id}/subscriptions` — list subscriptions for a tenant
- `GET /tenants/{id}/subscriptions/{subscriptionId}` — get subscription with resource summary
- `DELETE /tenants/{id}/subscriptions/{subscriptionId}` — delete subscription (only if empty)
- Add `subscription_id` filter to resource list endpoints
- Resource creation endpoints require `subscription_id` in the request body

## What Goes Where

| Data | Owner | Other systems |
|---|---|---|
| Tenants, resources | Hosting platform | Referenced by ID |
| Subscriptions (grouping) | Hosting platform | UUID generated by CRM |
| Customers, users, permissions | Control panel | — |
| Products, pricing, plans | CRM | — |
| Orders, invoices | CRM | References subscription UUID |
| Resource details (email addresses, DB names, etc.) | Hosting platform | Queried via API, never synced |
