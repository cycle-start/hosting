# hosting-cli — WireGuard Tunnel Client

`hosting-cli` is a standalone CLI tool that establishes userspace WireGuard tunnels for accessing tenant MySQL databases and Valkey caches from a local machine. It requires no root privileges or kernel modules — the tunnel runs entirely in userspace via netstack.

## Installation

```bash
go build ./cmd/hosting-cli
# or
go install github.com/edvin/hosting/cmd/hosting-cli@latest
```

## Quick Start

1. **Create a WireGuard peer** in the control panel (requires a subscription with the `wireguard` module)
2. **Download the `.conf` file** when prompted (the private key is shown only once)
3. **Import the config:**
   ```bash
   hosting-cli import peer.conf -tenant t_abc1234567
   ```
4. **Start proxying:**
   ```bash
   hosting-cli proxy
   ```
5. **Connect to your database:**
   ```bash
   mysql -h 127.0.0.1 -P 3306 -u db_abc1234567_admin -p
   ```

## Commands

### `import`

Import a WireGuard config file as a named profile.

```bash
hosting-cli import <config-file> [-name NAME] [-tenant TENANT_ID] [-set-active=true]
```

- `-name` — Profile name (default: derived from filename)
- `-tenant` — Associate profile with a tenant ID for multi-tenant management
- `-set-active` — Set as active profile after import (default: true)

The config file is copied to `~/.config/hosting/profiles/` along with metadata JSON.

### `profiles`

List all saved profiles, showing which one is active.

```bash
hosting-cli profiles
```

Output:
```
NAME                 TENANT                         ACTIVE
my-laptop            t_abc1234567                    *
ci-server            t_def7654321
```

Delete a profile:
```bash
hosting-cli profiles delete <name>
```

### `use`

Switch the active profile (context switch between tenants).

```bash
hosting-cli use <profile-name>
```

All commands that need a profile (tunnel, proxy, etc.) default to the active profile.

### `active`

Show details of the currently active profile.

```bash
hosting-cli active
```

Output:
```
Active profile: my-laptop
Tenant:         t_abc1234567
Address:        fd00:abcd:ffff::1/128
Endpoint:       gw.example.com:51820
Services:
  mysql → fd00:abcd:101::1388 (port 3306)
  valkey → fd00:abcd:201::1388 (port 6379)
```

### `tunnel`

Establish a WireGuard tunnel without proxying.

```bash
hosting-cli tunnel [profile-name]
hosting-cli tunnel -profile <name>
```

The tunnel stays active until Ctrl+C. Useful when you want to use the tunnel with other tools directly.

### `proxy`

Establish a tunnel and proxy services to localhost.

```bash
# Auto-proxy all services from config metadata
hosting-cli proxy [-mysql-port 3306] [-valkey-port 6379]

# Manual target
hosting-cli proxy -target [fd00::1]:3306 -port 3307
```

With service metadata in the config, `proxy` automatically sets up forwarding:
```
Establishing tunnel with profile "my-laptop"...
Proxying services:
  mysql → localhost:3306
  valkey → localhost:6379

Press Ctrl+C to disconnect.
```

### `status`

Show profile information and available services.

```bash
hosting-cli status
```

## Multi-Tenant Profiles

Each profile is stored with an optional tenant ID, enabling easy context switching:

```bash
# Import configs for different tenants
hosting-cli import staging.conf -tenant t_staging -name staging
hosting-cli import production.conf -tenant t_prod -name production

# Switch contexts
hosting-cli use staging
hosting-cli proxy  # connects to staging DB

hosting-cli use production
hosting-cli proxy  # connects to production DB

# Override without switching
hosting-cli proxy -profile staging
```

Profiles are stored in `~/.config/hosting/profiles/`:
```
~/.config/hosting/
  state.json                    # active profile
  profiles/
    staging.conf                # WireGuard config
    staging.json                # metadata (name, tenant_id)
    production.conf
    production.json
```

## Service Discovery

The WireGuard config generated by the platform includes service metadata as comments:

```ini
# hosting-cli:services
# mysql=fd00:abcd:101::1388
# valkey=fd00:abcd:201::1388
```

These addresses are the per-tenant ULA IPv6 addresses of the MySQL and Valkey services. The `proxy` command parses these to automatically set up port forwarding.

Service addresses are computed at peer creation time from the tenant's active databases and Valkey instances. If you add new databases after creating the peer, you can either:
- Create a new peer to get updated service metadata
- Use `proxy -target` to manually specify the address

## Architecture

The CLI uses the Go WireGuard userspace implementation (`golang.zx2c4.com/wireguard`) with a netstack-based TUN device (`golang.zx2c4.com/wireguard/tun/netstack`). This means:

- No root/sudo required
- No kernel WireGuard module needed
- Works on any platform (Linux, macOS, Windows)
- The tunnel exists only within the process — no system network changes

Traffic flow:
```
localhost:3306 → hosting-cli proxy → WireGuard tunnel → Gateway node → DB node ULA
```
