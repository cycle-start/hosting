# hosting-cli — WireGuard Tunnel Client

`hosting-cli` is a standalone CLI tool that establishes userspace WireGuard tunnels for accessing tenant MySQL databases and Valkey caches from a local machine. It requires no root privileges or kernel modules — the tunnel runs entirely in userspace via netstack.

## Installation

```bash
go build ./cmd/hosting-cli
# or
go install github.com/edvin/hosting/cmd/hosting-cli@latest
```

## Quick Start

1. **Create a WireGuard peer** in the control panel (requires a subscription with the `wireguard` module)
2. **Download the `.conf` file** when prompted (the private key is shown only once)
3. **Import the config:**
   ```bash
   hosting-cli import my-laptop.conf -tenant t_a8k2mxp4q7
   ```
   This saves the profile as `t_a8k2mxp4q7` (the tenant ID is used as the profile name by default).
4. **Start proxying:**
   ```bash
   hosting-cli proxy
   ```
5. **Connect to your database:**
   ```bash
   mysql -h 127.0.0.1 -P 3306 -u db_xr9f3k1m7n_admin -p
   ```

## Commands

### `import`

Import a WireGuard config file as a profile.

```bash
hosting-cli import <config-file> [-tenant TENANT_ID] [-name NAME] [-set-active=true]
```

- `-tenant` — Tenant ID; also used as the profile name unless `-name` is given
- `-name` — Override the profile name (default: tenant ID, or filename if no tenant)
- `-set-active` — Set as active profile after import (default: true)

The config file is copied to `~/.config/hosting/profiles/` along with metadata JSON.

### `profiles`

List all saved profiles, showing which one is active.

```bash
hosting-cli profiles
```

Output:
```
NAME                 TENANT                         ACTIVE
t_a8k2mxp4q7        t_a8k2mxp4q7                    *
t_n3jf7w2x9p        t_n3jf7w2x9p
```

Delete a profile:
```bash
hosting-cli profiles delete <name>
```

### `use`

Switch the active profile (context switch between tenants).

```bash
hosting-cli use t_n3jf7w2x9p
```

All commands that need a profile (tunnel, proxy, etc.) default to the active profile.

### `active`

Show details of the currently active profile.

```bash
hosting-cli active
```

Output:
```
Active profile: t_a8k2mxp4q7
Tenant:         t_a8k2mxp4q7
Address:        fd00:abcd:ffff::1/128
Endpoint:       gw.massive-hosting.com:51820
Services:
  mysql → fd00:abcd:101::1388 (port 3306)
  valkey → fd00:abcd:201::1388 (port 6379)
```

### `tunnel`

Establish a WireGuard tunnel without proxying.

```bash
hosting-cli tunnel [profile-name]
hosting-cli tunnel -profile <name>
```

The tunnel stays active until Ctrl+C. Useful when you want to use the tunnel with other tools directly.

### `proxy`

Establish a tunnel and proxy services to localhost.

```bash
# Auto-proxy all services from config metadata
hosting-cli proxy [-mysql-port 3306] [-valkey-port 6379]

# Manual target
hosting-cli proxy -target [fd00::1]:3306 -port 3307
```

With service metadata in the config, `proxy` automatically sets up forwarding:
```
Establishing tunnel with profile "t_a8k2mxp4q7"...
Proxying services:
  mysql → localhost:3306
  valkey → localhost:6379

Press Ctrl+C to disconnect.
```

### `status`

Show profile information and available services.

```bash
hosting-cli status
```

## Multi-Tenant Profiles

Each profile maps to a tenant. The profile name defaults to the tenant ID, so switching tenants is straightforward:

```bash
# Import configs for different tenants
hosting-cli import laptop.conf -tenant t_a8k2mxp4q7
hosting-cli import laptop.conf -tenant t_n3jf7w2x9p

# Switch between tenants
hosting-cli use t_a8k2mxp4q7
hosting-cli proxy  # proxies t_a8k2mxp4q7's MySQL and Valkey

hosting-cli use t_n3jf7w2x9p
hosting-cli proxy  # proxies t_n3jf7w2x9p's MySQL and Valkey

# One-off connection without switching the active tenant
hosting-cli proxy -profile t_a8k2mxp4q7
```

Profiles are stored in `~/.config/hosting/profiles/`:
```
~/.config/hosting/
  state.json                       # active profile
  profiles/
    t_a8k2mxp4q7.conf             # WireGuard config
    t_a8k2mxp4q7.json             # metadata (name, tenant_id)
    t_n3jf7w2x9p.conf
    t_n3jf7w2x9p.json
```

## Service Discovery

The WireGuard config generated by the platform includes service metadata as comments:

```ini
# hosting-cli:services
# mysql=fd00:abcd:101::1388
# valkey=fd00:abcd:201::1388
```

These addresses are the per-tenant ULA IPv6 addresses of the MySQL and Valkey services. The `proxy` command parses these to automatically set up port forwarding.

Service addresses are computed at peer creation time from the tenant's active databases and Valkey instances. If you add new databases after creating the peer, you can either:
- Create a new peer to get updated service metadata
- Use `proxy -target` to manually specify the address

## Architecture

The CLI uses the Go WireGuard userspace implementation (`golang.zx2c4.com/wireguard`) with a netstack-based TUN device (`golang.zx2c4.com/wireguard/tun/netstack`). This means:

- No root/sudo required
- No kernel WireGuard module needed
- Works on any platform (Linux, macOS, Windows)
- The tunnel exists only within the process — no system network changes

Traffic flow:
```
localhost:3306 → hosting-cli proxy → WireGuard tunnel → Gateway node → DB node ULA
```
