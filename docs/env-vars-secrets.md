# Environment Variables & Vaulted Secrets

## Overview

Webroots support environment variables that are available to PHP-FPM processes, cron jobs, daemons, and SSH sessions. Secret values are encrypted at rest using per-tenant envelope encryption.

## API Endpoints

All endpoints are scoped under `webroots` permissions.

### List env vars

```
GET /api/v1/webroots/{webrootID}/env-vars
```

Returns all env vars. Secret values are redacted to `"***"`.

**Response:**
```json
{
  "items": [
    {"name": "DATABASE_URL", "value": "mysql://user:pass@host/db", "is_secret": false},
    {"name": "APP_KEY", "value": "***", "is_secret": true}
  ]
}
```

### Set env vars (bulk replace)

```
PUT /api/v1/webroots/{webrootID}/env-vars
```

Replaces all env vars for the webroot. Triggers a re-convergence workflow.

**Request body:**
```json
{
  "vars": [
    {"name": "DATABASE_URL", "value": "mysql://user:pass@host/db", "secret": false},
    {"name": "APP_KEY", "value": "base64:abc123", "secret": true}
  ]
}
```

Var name validation: `^[A-Za-z_][A-Za-z0-9_]{0,127}$`

### Delete single env var

```
DELETE /api/v1/webroots/{webrootID}/env-vars/{name}
```

Removes a single env var by name. Triggers a re-convergence workflow.

## Webroot Configuration

Two new fields on the webroot control env var behavior:

| Field | Default | Description |
|-------|---------|-------------|
| `env_file_name` | `.env.hosting` | Filename for the env file written to the webroot directory |
| `env_shell_source` | `false` | Whether to auto-source the env file in SSH shell sessions |

Set via webroot create/update:
```json
{
  "runtime": "php",
  "runtime_version": "8.5",
  "env_file_name": ".env",
  "env_shell_source": true
}
```

## Injection Targets

### PHP-FPM

Env vars are injected as `env[KEY] = value` lines in the PHP-FPM pool config. Available to all PHP scripts via `$_ENV` and `getenv()`.

### Env file

Written to `/var/www/storage/{tenant}/webroots/{webroot}/{env_file_name}` with mode `0400`. Format:

```bash
# Auto-generated by hosting platform. Do not edit.
DATABASE_URL="mysql://user:pass@host/db"
APP_KEY="base64:abc123"
```

### Cron jobs

Cron job systemd units can reference the env file via `EnvironmentFile=`.

### Daemons

Webroot env vars are available in the env file. Daemon-specific `Environment` vars take precedence.

### SSH sessions

When `env_shell_source = true`, a block is managed in the tenant's `.bashrc`:

```bash
# hosting-env-start (auto-generated, do not edit)
[ -f /webroots/myapp/.env ] && set -a && . /webroots/myapp/.env && set +a
# hosting-env-end
```

## Encryption Architecture

### Per-tenant envelope encryption

- **Master key (KEK)**: AES-256 key from `SECRET_ENCRYPTION_KEY` env var (32 bytes, hex-encoded). Required for `core-api` and `worker`.
- **Tenant DEK**: Random 32-byte AES-256 key per tenant, encrypted by KEK. Stored in `tenant_encryption_keys` table. Lazy-initialized on first secret.
- **Secret values**: Encrypted with tenant DEK using AES-256-GCM. Stored as base64 in `webroot_env_vars.value`.

### Flow

**Write:** API receives plaintext -> get/create tenant DEK -> encrypt value with DEK -> store ciphertext in DB.

**Read (API):** Secret values returned as `"***"` (never decrypted for API responses).

**Read (convergence):** Fetch encrypted value -> decrypt DEK with KEK -> decrypt value with DEK -> plaintext flows to node agents via Temporal activity params.

**On node:** Secrets arrive as plaintext, written to FPM config and env file (same security model as database passwords).

## PHP Runtime Config

The `runtime_config` JSON field is now parsed for PHP webroots to configure PHP-FPM pool settings:

```json
{
  "pm": {
    "max_children": 10,
    "start_servers": 3,
    "min_spare_servers": 2,
    "max_spare_servers": 5,
    "max_requests": 1000
  },
  "php_values": {
    "memory_limit": "256M",
    "max_execution_time": "60",
    "upload_max_filesize": "64M"
  },
  "php_admin_values": {
    "session.save_handler": "files"
  }
}
```

All fields are optional. Missing fields use defaults (max_children=5, start_servers=2, etc.).

### Blocklisted php_admin_values

The following keys cannot be overridden as they are managed by the platform:
- `open_basedir`
- `error_log`
- `slowlog`
- `disable_functions`
- `doc_root`

### PM validation ranges

| Setting | Min | Max |
|---------|-----|-----|
| `max_children` | 1 | 200 |
| `start_servers` | 1 | 200 |
| `min_spare_servers` | 1 | 200 |
| `max_spare_servers` | 1 | 200 |
| `max_requests` | 0 | 100000 |

## Configuration

| Env var | Required by | Description |
|---------|-------------|-------------|
| `SECRET_ENCRYPTION_KEY` | core-api, worker | 32-byte AES-256 master key, hex-encoded (64 hex chars) |

Generate a key:
```bash
openssl rand -hex 32
```

## Database Tables

### `tenant_encryption_keys`

Stores per-tenant DEKs encrypted by the platform master key.

### `webroot_env_vars`

Stores env vars per webroot. Secret values are encrypted. Cascading delete on webroot removal.

### Webroot columns

- `env_file_name` (TEXT, default `.env.hosting`): Name of the env file.
- `env_shell_source` (BOOLEAN, default false): Auto-source in SSH sessions.
