- name: Wait for cloud-init
  hosts: all
  gather_facts: false
  tasks:
    - name: Wait for cloud-init to finish
      ansible.builtin.command: cloud-init status --wait
      changed_when: false
      failed_when: false

    - name: Create Ansible remote tmp directory
      file:
        path: /root/.ansible/tmp
        state: directory
        mode: "0700"

- name: Storage nodes
  hosts: storage
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: ceph_server, tags: [ceph-server] }
    - { role: node_agent, tags: [node-agent] }

- name: Web nodes
  hosts: web
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: tenant_network, tags: [network] }
    - { role: nginx, tags: [nginx] }
    - { role: php, tags: [php] }
    - { role: composer, tags: [composer] }
    - { role: client_tools, tags: [client-tools] }
    - { role: ceph_client, tags: [ceph-client] }
    - { role: supervisor, tags: [supervisor] }
    - { role: node_agent, tags: [node-agent] }

- name: Database nodes
  hosts: db
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: tenant_network, tags: [network] }
    - { role: mysql, tags: [mysql] }
    - { role: node_agent, tags: [node-agent] }

- name: DNS nodes
  hosts: dns
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: powerdns, tags: [powerdns] }
    - { role: node_agent, tags: [node-agent] }

- name: Valkey nodes
  hosts: valkey
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: tenant_network, tags: [network] }
    - { role: valkey_server, tags: [valkey] }
    - { role: node_agent, tags: [node-agent] }

- name: Email nodes
  hosts: email
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: stalwart, tags: [stalwart] }
    - { role: node_agent, tags: [node-agent] }

- name: Load balancer nodes
  hosts: lb
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: haproxy, tags: [haproxy] }
    - { role: node_agent, tags: [node-agent] }

- name: DB Admin nodes
  hosts: dbadmin
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: dbadmin, tags: [dbadmin] }
    - { role: node_agent, tags: [node-agent] }

- name: Gateway nodes
  hosts: gateway
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: tenant_network, tags: [network] }
    - { role: wireguard_server, tags: [wireguard] }
    - { role: node_agent, tags: [node-agent] }

- name: Control plane nodes
  hosts: controlplane
  roles:
    - { role: vector, tags: [vector] }
    - { role: k3s, tags: [k3s] }
  tasks:
    - name: Wait for PowerDNS database to be ready
      wait_for:
        host: "{{ powerdns_db_host | default('127.0.0.1') }}"
        port: "{{ powerdns_db_port | default('5433') }}"
        timeout: 120
      when: "'dns' in group_names"
      tags: [powerdns]

    - name: Start PowerDNS now that database is available
      systemd:
        name: pdns
        state: restarted
      when: "'dns' in group_names"
      tags: [powerdns]
