- name: Wait for cloud-init
  hosts: all
  gather_facts: false
  tasks:
    - name: Wait for cloud-init to finish
      ansible.builtin.command: cloud-init status --wait
      changed_when: false

- name: Storage nodes
  hosts: storage
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: ceph_server, tags: [ceph-server] }
    - { role: node_agent, tags: [node-agent] }

- name: Web nodes
  hosts: web
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: nginx, tags: [nginx] }
    - { role: php, tags: [php] }
    - { role: composer, tags: [composer] }
    - { role: client_tools, tags: [client-tools] }
    - { role: ceph_client, tags: [ceph-client] }
    - { role: supervisor, tags: [supervisor] }
    - { role: node_agent, tags: [node-agent] }

- name: Database nodes
  hosts: db
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: mysql, tags: [mysql] }
    - { role: node_agent, tags: [node-agent] }

- name: DNS nodes
  hosts: dns
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: powerdns, tags: [powerdns] }
    - { role: node_agent, tags: [node-agent] }

- name: Valkey nodes
  hosts: valkey
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: valkey_server, tags: [valkey] }
    - { role: node_agent, tags: [node-agent] }

- name: Email nodes
  hosts: email
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: stalwart, tags: [stalwart] }
    - { role: node_agent, tags: [node-agent] }

- name: Load balancer nodes
  hosts: lb
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: haproxy, tags: [haproxy] }
    - { role: node_agent, tags: [node-agent] }

- name: DB Admin nodes
  hosts: dbadmin
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: dbadmin, tags: [dbadmin] }
    - { role: node_agent, tags: [node-agent] }

- name: Gateway nodes
  hosts: gateway
  roles:
    - { role: ssh_hardening, tags: [ssh] }
    - { role: vector, tags: [vector] }
    - { role: wireguard_server, tags: [wireguard] }
    - { role: node_agent, tags: [node-agent] }

- name: Control plane nodes
  hosts: controlplane
  roles:
    - { role: vector, tags: [vector] }
    - { role: k3s, tags: [k3s] }
