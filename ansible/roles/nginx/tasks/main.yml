- name: Install nginx
  apt:
    name: nginx
    state: present
    update_cache: true
  register: nginx_install

# Nginx auto-starts on install with a default site on port 80.
# Remove it immediately to avoid port conflicts with HAProxy in single-node mode.
- name: Remove default nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  register: nginx_default_removed

- name: Reload nginx after removing default site
  systemd:
    name: nginx
    state: reloaded
  when: nginx_default_removed.changed

- name: Deploy hosting JSON log format
  copy:
    content: |
      log_format hosting_json escape=json
        '{'
          '"time":"$time_iso8601",'
          '"remote_addr":"$remote_addr",'
          '"method":"$request_method",'
          '"uri":"$request_uri",'
          '"status":$status,'
          '"bytes_sent":$bytes_sent,'
          '"request_time":$request_time,'
          '"upstream_time":"$upstream_response_time",'
          '"http_referer":"$http_referer",'
          '"http_user_agent":"$http_user_agent",'
          '"host":"$host",'
          '"server_name":"$server_name"'
        '}';
    dest: /etc/nginx/conf.d/hosting-log-format.conf
  notify: reload nginx

- name: Deploy tenant log rotation config
  copy:
    content: |
      /var/log/hosting/*/*.log {
          daily
          rotate 2
          compress
          delaycompress
          missingok
          notifempty
          copytruncate
          maxsize 100M
      }
    dest: /etc/logrotate.d/hosting-tenant-logs

- name: Enable nginx
  systemd:
    name: nginx
    enabled: true
    state: started
