- name: Install WireGuard packages
  apt:
    name:
      - wireguard
      - wireguard-tools
    state: present
    update_cache: true

- name: Enable IPv6 forwarding
  sysctl:
    name: net.ipv6.conf.all.forwarding
    value: "1"
    sysctl_set: true
    state: present
    reload: true

- name: Create /etc/wireguard directory
  file:
    path: /etc/wireguard
    state: directory
    mode: "0700"

- name: Generate WireGuard server keypair
  shell: |
    umask 077
    wg genkey > /etc/wireguard/server.key
    wg pubkey < /etc/wireguard/server.key > /etc/wireguard/server.pub
  args:
    creates: /etc/wireguard/server.key

- name: Read server private key
  slurp:
    src: /etc/wireguard/server.key
  register: wg_server_key

- name: Deploy wg0 config
  copy:
    dest: /etc/wireguard/wg0.conf
    owner: root
    group: root
    mode: "0600"
    content: |
      [Interface]
      PrivateKey = {{ wg_server_key.content | b64decode | trim }}
      ListenPort = 51820
  notify: restart wireguard

- name: Enable and start wg-quick@wg0
  systemd:
    name: wg-quick@wg0
    enabled: true
    state: started
