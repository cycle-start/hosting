- name: Install Ceph packages
  apt:
    name:
      - ceph
      - ceph-mon
      - ceph-osd
      - ceph-mgr
      - ceph-mds
      - radosgw
      - lvm2
      - jq
    state: present
    update_cache: true

- name: Create hosting directory
  file:
    path: /opt/hosting
    state: directory
    mode: "0755"

- name: Deploy Ceph setup script
  template:
    src: setup-ceph.sh.j2
    dest: /opt/hosting/setup-ceph.sh
    mode: "0755"

- name: Check if Ceph is initialized
  stat:
    path: /etc/ceph/ceph.client.admin.keyring
  register: ceph_admin_keyring

- name: Run Ceph setup script
  command: /opt/hosting/setup-ceph.sh
  when: not ceph_admin_keyring.stat.exists

- name: Start Ceph core services
  systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  loop:
    - "ceph-mon@{{ ansible_hostname }}"
    - "ceph-mgr@{{ ansible_hostname }}"
  when: ceph_admin_keyring.stat.exists

# MDS setup â€” idempotent tasks so re-runs recover from partial first runs

- name: Check if MDS keyring exists
  stat:
    path: "/var/lib/ceph/mds/ceph-{{ ansible_hostname }}/keyring"
  register: ceph_mds_keyring
  when: ceph_filestore_enabled | default(false)

- name: Create MDS keyring
  shell: |
    mkdir -p /var/lib/ceph/mds/ceph-{{ ansible_hostname }}
    ceph auth get-or-create mds.{{ ansible_hostname }} \
      osd 'allow rwx' mds 'allow *' mon 'allow profile mds' \
      > /var/lib/ceph/mds/ceph-{{ ansible_hostname }}/keyring
    chown -R ceph:ceph /var/lib/ceph/mds/ceph-{{ ansible_hostname }}
  when:
    - ceph_filestore_enabled | default(false)
    - ceph_admin_keyring.stat.exists
    - not ceph_mds_keyring.stat.exists

- name: Create CephFS pools and filesystem
  shell: |
    ceph osd pool create cephfs_data 32 2>/dev/null || true
    ceph osd pool create cephfs_metadata 16 2>/dev/null || true
    ceph fs new cephfs cephfs_metadata cephfs_data 2>/dev/null || true
  changed_when: false
  when:
    - ceph_filestore_enabled | default(false)
    - ceph_admin_keyring.stat.exists

- name: Copy CephFS web client keyring
  copy:
    src: "{{ ceph_web_keyring_file }}"
    dest: /etc/ceph/ceph.client.web.keyring
    mode: "0600"
  when:
    - ceph_filestore_enabled | default(false)
    - ceph_admin_keyring.stat.exists
    - ceph_web_keyring_file is defined

- name: Import CephFS web client key into Ceph auth
  command: ceph auth import -i /etc/ceph/ceph.client.web.keyring
  changed_when: false
  when:
    - ceph_filestore_enabled | default(false)
    - ceph_admin_keyring.stat.exists
    - ceph_web_keyring_file is defined

- name: Start Ceph MDS
  systemd:
    name: "ceph-mds@{{ ansible_hostname }}"
    enabled: true
    state: started
  when:
    - ceph_filestore_enabled | default(false)
    - ceph_admin_keyring.stat.exists

- name: Wait for MDS to become active
  command: ceph mds stat --format=json
  register: mds_stat
  until: "'up:active' in mds_stat.stdout"
  retries: 30
  delay: 5
  changed_when: false
  when:
    - ceph_filestore_enabled | default(false)
    - ceph_admin_keyring.stat.exists
