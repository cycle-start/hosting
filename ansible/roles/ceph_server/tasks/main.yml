- name: Install Ceph packages
  apt:
    name:
      - ceph
      - ceph-mon
      - ceph-osd
      - ceph-mgr
      - ceph-mds
      - radosgw
      - lvm2
      - jq
    state: present
    update_cache: true

- name: Create hosting directory
  file:
    path: /opt/hosting
    state: directory
    mode: "0755"

- name: Deploy Ceph setup script
  template:
    src: setup-ceph.sh.j2
    dest: /opt/hosting/setup-ceph.sh
    mode: "0755"

- name: Check if Ceph is initialized
  stat:
    path: /etc/ceph/ceph.client.admin.keyring
  register: ceph_admin_keyring

- name: Run Ceph setup script
  command: /opt/hosting/setup-ceph.sh
  when: not ceph_admin_keyring.stat.exists

- name: Start Ceph core services
  systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  loop:
    - "ceph-mon@{{ ansible_hostname }}"
    - "ceph-mgr@{{ ansible_hostname }}"
  when: ceph_admin_keyring.stat.exists

- name: Start Ceph MDS
  systemd:
    name: "ceph-mds@{{ ansible_hostname }}"
    enabled: true
    state: started
  when: ceph_admin_keyring.stat.exists and (ceph_filestore_enabled | default(false))
