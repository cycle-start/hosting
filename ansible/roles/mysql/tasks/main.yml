- name: Install MySQL server
  apt:
    name: mysql-server
    state: present
    update_cache: true

- name: Configure MySQL root for passwordless TCP access
  shell: |
    systemctl start mysql
    mysql -u root -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY ''; FLUSH PRIVILEGES;"
    systemctl stop mysql
  args:
    creates: /etc/mysql/mysql.conf.d/replication.cnf

- name: Check for cloud-init staged server-id config
  stat:
    path: /usr/local/etc/mysql/server-id.cnf
  register: staged_server_id

- name: Deploy staged server-id config
  copy:
    src: /usr/local/etc/mysql/server-id.cnf
    dest: /etc/mysql/mysql.conf.d/server-id.cnf
    remote_src: true
  when: staged_server_id.stat.exists
  notify: restart mysql

- name: Deploy GTID replication config
  template:
    src: replication.cnf.j2
    dest: /etc/mysql/mysql.conf.d/replication.cnf
  notify: restart mysql

- name: Remove auto.cnf for unique server UUID
  file:
    path: /var/lib/mysql/auto.cnf
    state: absent

- name: Enable and start MySQL
  systemd:
    name: mysql
    enabled: true
    state: started

- name: Create replication user
  community.mysql.mysql_user:
    name: repl
    host: "%"
    password: "{{ mysql_repl_password }}"
    priv: "*.*:REPLICATION SLAVE,REPLICATION CLIENT"
    state: present
    login_unix_socket: /var/run/mysqld/mysqld.sock
  when: mysql_repl_password is defined
