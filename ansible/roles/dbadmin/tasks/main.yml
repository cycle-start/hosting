- name: Install nginx and PHP-FPM
  apt:
    name:
      - nginx
      - php-fpm
      - php-mysql
      - php-mbstring
      - php-zip
      - php-gd
      - php-json
      - php-curl
    state: present
    update_cache: true

- name: Download phpMyAdmin
  unarchive:
    src: https://files.phpmyadmin.net/phpMyAdmin/5.2.2/phpMyAdmin-5.2.2-all-languages.tar.gz
    dest: /opt
    remote_src: true
    creates: /opt/phpMyAdmin-5.2.2-all-languages

- name: Symlink phpMyAdmin to /opt/phpmyadmin
  file:
    src: /opt/phpMyAdmin-5.2.2-all-languages
    dest: /opt/phpmyadmin
    state: link
    force: true

- name: Create session directories
  file:
    path: "{{ item }}"
    state: directory
    mode: "0777"
  loop:
    - /tmp/dbadmin-sessions
    - /tmp/phpmyadmin

- name: Create hosting bin directory
  file:
    path: /opt/hosting/bin
    state: directory
    mode: "0755"

- name: Copy dbadmin-proxy binary
  copy:
    src: "{{ dbadmin_proxy_binary_path }}"
    dest: /opt/hosting/bin/dbadmin-proxy
    mode: "0755"
  notify: restart dbadmin-proxy

- name: Deploy dbadmin-proxy systemd unit
  template:
    src: dbadmin-proxy.service.j2
    dest: /etc/systemd/system/dbadmin-proxy.service
  notify: restart dbadmin-proxy

- name: Enable dbadmin-proxy
  systemd:
    name: dbadmin-proxy
    daemon_reload: true
    enabled: true
