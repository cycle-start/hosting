- name: Install nginx and PHP-FPM
  apt:
    name:
      - nginx
      - php-fpm
      - php-mysql
      - php-mbstring
      - php-zip
      - php-gd
      - php-json
      - php-curl
    state: present
    update_cache: true

- name: Download phpMyAdmin
  unarchive:
    src: https://files.phpmyadmin.net/phpMyAdmin/5.2.2/phpMyAdmin-5.2.2-all-languages.tar.gz
    dest: /opt
    remote_src: true
    creates: /opt/phpMyAdmin-5.2.2-all-languages

- name: Symlink phpMyAdmin to /opt/phpmyadmin
  file:
    src: /opt/phpMyAdmin-5.2.2-all-languages
    dest: /opt/phpmyadmin
    state: link
    force: true

- name: Create session directories
  file:
    path: "{{ item }}"
    state: directory
    mode: "0777"
  loop:
    - /tmp/dbadmin-sessions
    - /tmp/phpmyadmin

- name: Create hosting bin directory
  file:
    path: /opt/hosting/bin
    state: directory
    mode: "0755"

- name: Copy dbadmin-proxy binary
  copy:
    src: "{{ dbadmin_proxy_binary_path }}"
    dest: /opt/hosting/bin/dbadmin-proxy
    mode: "0755"
  notify: restart dbadmin-proxy

- name: Deploy dbadmin-proxy systemd unit
  template:
    src: dbadmin-proxy.service.j2
    dest: /etc/systemd/system/dbadmin-proxy.service
  notify: restart dbadmin-proxy

- name: Write dbadmin-proxy environment config
  template:
    src: dbadmin-proxy.env.j2
    dest: /etc/default/dbadmin-proxy
    mode: "0640"
  when: core_api_url is defined
  notify: restart dbadmin-proxy

- name: Deploy phpMyAdmin config
  template:
    src: config.inc.php.j2
    dest: /opt/phpmyadmin/config.inc.php
    mode: "0644"

- name: Deploy phpMyAdmin signon script
  template:
    src: signon.php.j2
    dest: /opt/phpmyadmin/signon.php
    mode: "0644"

- name: Create nginx certs directory
  file:
    path: /etc/nginx/certs
    state: directory
    mode: "0755"

- name: Generate self-signed SSL cert for dbadmin
  command:
    cmd: >
      openssl req -x509 -newkey rsa:2048
      -keyout /etc/nginx/certs/dbadmin-key.pem -out /etc/nginx/certs/dbadmin.pem
      -days 365 -nodes -subj '/CN=dbadmin'
    creates: /etc/nginx/certs/dbadmin.pem

- name: Deploy nginx site config
  template:
    src: dbadmin-nginx.conf.j2
    dest: /etc/nginx/sites-available/dbadmin
    mode: "0644"
  notify: restart nginx

- name: Disable default nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: restart nginx

- name: Enable dbadmin nginx site
  file:
    src: /etc/nginx/sites-available/dbadmin
    dest: /etc/nginx/sites-enabled/dbadmin
    state: link
  notify: restart nginx

- name: Detect installed PHP-FPM version
  shell: "dpkg -l 'php*-fpm' | awk '/^ii/ && /php[0-9]/ {print $2}' | head -1 | sed 's/-fpm//'"
  register: php_fpm_pkg
  changed_when: false

- name: Enable and start PHP-FPM
  systemd:
    name: "{{ php_fpm_pkg.stdout }}-fpm"
    enabled: true
    state: started

- name: Enable and start nginx
  systemd:
    name: nginx
    enabled: true
    state: started

- name: Enable dbadmin-proxy
  systemd:
    name: dbadmin-proxy
    daemon_reload: true
    enabled: true
    state: started
