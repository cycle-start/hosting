- name: Create resolved.conf.d directory
  file:
    path: /etc/systemd/resolved.conf.d
    state: directory
    mode: "0755"

- name: Disable systemd-resolved stub listener
  copy:
    content: |
      [Resolve]
      DNSStubListener=no
    dest: /etc/systemd/resolved.conf.d/no-stub.conf
  register: resolved_conf

- name: Restart systemd-resolved to free port 53
  systemd:
    name: systemd-resolved
    state: restarted
  when: resolved_conf.changed

- name: Install PowerDNS
  apt:
    name:
      - pdns-server
      - pdns-backend-pgsql
    state: present
    update_cache: true

- name: Remove default BIND backend config
  file:
    path: /etc/powerdns/pdns.d/bind.conf
    state: absent
  notify: restart powerdns

- name: Deploy PostgreSQL backend config
  template:
    src: gpgsql.conf.j2
    dest: /etc/powerdns/pdns.d/gpgsql.conf
    owner: pdns
    group: pdns
    mode: "0640"
  notify: restart powerdns

- name: Enable and start PowerDNS
  systemd:
    name: pdns
    enabled: true
    state: started
