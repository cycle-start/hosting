global
    log stdout format raw local0
    maxconn 4096
    stats socket /var/run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats socket ipv4@:9999 level admin
    stats timeout 30s

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

# Stats UI
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s

# Main HTTP/HTTPS frontend
frontend http
    bind *:80
    bind *:443 ssl crt /etc/haproxy/certs/hosting.pem alpn http/1.1

{% if base_domain is defined %}
    # Control plane services (by exact hostname)
    acl is_home        hdr(host) -i home.{{ base_domain }}
    acl is_admin       hdr(host) -i admin.{{ base_domain }}
    acl is_api         hdr(host) -i api.{{ base_domain }}
    acl is_dbadmin     hdr(host) -i dbadmin.{{ base_domain }}
    acl is_temporal    hdr(host) -i temporal.{{ base_domain }}
    acl is_grafana     hdr(host) -i grafana.{{ base_domain }}
    acl is_prometheus  hdr(host) -i prometheus.{{ base_domain }}
    acl is_mcp         hdr(host) -i mcp.{{ base_domain }}
    acl is_headlamp    hdr(host) -i headlamp.{{ base_domain }}

    use_backend bk_controlpanel   if is_home
    use_backend bk_admin          if is_admin
    use_backend bk_core_api       if is_api
    use_backend bk_dbadmin        if is_dbadmin
    use_backend bk_temporal       if is_temporal
    use_backend bk_grafana        if is_grafana
    use_backend bk_prometheus     if is_prometheus
    use_backend bk_mcp            if is_mcp
    use_backend bk_headlamp      if is_headlamp
{% endif %}

    # Tenant routing via dynamic FQDN map (fallback)
    use_backend %[req.hdr(host),lower,map(/var/lib/haproxy/maps/fqdn-to-shard.map,shard-default)]

# Default backend (returns 503 for unmapped FQDNs)
backend shard-default
    mode http
    http-request deny deny_status 503

{% if base_domain is defined %}
# Control plane backends
backend bk_controlpanel
    server controlpanel {{ controlplane_ip | default('127.0.0.1') }}:3002 check

backend bk_admin
    server admin {{ controlplane_ip | default('127.0.0.1') }}:3001 check

backend bk_core_api
    server coreapi {{ controlplane_ip | default('127.0.0.1') }}:8090 check

backend bk_dbadmin
{% for host in groups.get('dbadmin', []) %}
    server {{ host }} {{ hostvars[host].ansible_host | default('127.0.0.1') }}:{{ hostvars[host].dbadmin_listen_port | default('443') }} check ssl verify none
{% endfor %}

backend bk_temporal
    server temporal {{ controlplane_ip | default('127.0.0.1') }}:8233 check

backend bk_grafana
    server grafana {{ controlplane_ip | default('127.0.0.1') }}:3000 check

backend bk_prometheus
    server prometheus {{ controlplane_ip | default('127.0.0.1') }}:{{ prometheus_backend_port | default('9090') }} check

backend bk_mcp
    server mcp {{ controlplane_ip | default('127.0.0.1') }}:8091 check

backend bk_headlamp
    server headlamp {{ controlplane_ip | default('127.0.0.1') }}:4466 check
{% endif %}

# Shard backends with real VM IPs
{# Build shard map from web group inventory #}
{% set shard_map = {} %}
{% for host in groups.get('web', []) %}
{%   set hv = hostvars[host] %}
{%   set sname = hv.shard_name | default('web-1') %}
{%   if sname not in shard_map %}
{%     set _ = shard_map.update({sname: []}) %}
{%   endif %}
{%   set _ = shard_map[sname].append({'name': host, 'ip': hv.ansible_host}) %}
{% endfor %}
{% for sname, members in shard_map.items() %}
backend shard-{{ sname }}
    balance hdr(Host)
    hash-type consistent
{% for server in members %}
    server {{ server.name }} {{ server.ip }}:{{ web_backend_port | default('80') }} check
{% endfor %}

{% endfor %}
