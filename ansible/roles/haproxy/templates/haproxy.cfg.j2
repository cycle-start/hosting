global
    log stdout format raw local0
    maxconn 4096
    stats socket /var/run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats socket ipv4@:9999 level admin
    stats timeout 30s

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

# Stats UI
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s

# Main HTTP/HTTPS frontend (tenant traffic)
frontend http
    bind *:80
    bind *:443 ssl crt /etc/haproxy/certs/hosting.pem alpn http/1.1
    # Tenant routing via dynamic FQDN map; unmapped hosts go to the default web shard
    use_backend %[req.hdr(host),lower,map(/var/lib/haproxy/maps/fqdn-to-shard.map)]
    default_backend shard-web-1

# Shard backends â€” populated by cloud-init with real IPs.
# Ansible deploys a minimal config so HAProxy can start;
# cloud-init rerun overwrites this with the full shard list.
