# Base Vector config for all node VMs.
# Collects node-agent logs from journald and ships to Loki.

[sources.journald_node_agent]
type = "journald"
include_units = ["node-agent"]

[transforms.parse_node_agent]
type = "remap"
inputs = ["journald_node_agent"]
source = '''
# node-agent outputs zerolog JSON; parse it.
parsed, err = parse_json(.message)
if err == null {
  msg = del(parsed.message)
  if msg != null { .message = to_string!(msg) }
  level = del(parsed.level)
  .level = if level != null { to_string!(level) } else { "info" }
  svc = del(parsed.service)
  .service = if svc != null { to_string!(svc) } else { "node-agent" }
  region = del(parsed.region)
  .region = if region != null { to_string!(region) } else { "" }
  cluster = del(parsed.cluster)
  .cluster = if cluster != null { to_string!(cluster) } else { "" }
  shard = del(parsed.shard)
  .shard = if shard != null { to_string!(shard) } else { "" }
  node_id = del(parsed.node_id)
  .node_id = if node_id != null { to_string!(node_id) } else { "" }
  node_role = del(parsed.node_role)
  .node_role = if node_role != null { to_string!(node_role) } else { "" }
} else {
  .level = "info"
  .service = "node-agent"
}
'''

[sinks.loki]
type = "loki"
inputs = ["parse_node_agent"]
endpoint = "{{ loki_endpoint }}"
encoding.codec = "text"

{% raw %}
[sinks.loki.labels]
service = "{{ service }}"
hostname = "{{ host }}"
level = "{{ level }}"
region = "{{ region }}"
cluster = "{{ cluster }}"
shard = "{{ shard }}"
node_role = "{{ node_role }}"
job = "node-agent"
{% endraw %}
