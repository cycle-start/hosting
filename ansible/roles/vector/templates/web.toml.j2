# Additional Vector sources for web nodes.
# Collects per-tenant logs and ships to tenant Loki (port 3101).

# Per-tenant nginx access logs (JSON format)
[sources.tenant_access_logs]
type = "file"
include = ["/var/log/hosting/**/*-access.log"]
read_from = "end"
glob_minimum_cooldown_ms = 5000

[transforms.parse_tenant_access]
type = "remap"
inputs = ["tenant_access_logs"]
source = '''
# Extract tenant_id and webroot_id from file path
# Path: /var/log/hosting/{tenant_id}/{webroot_id}-access.log
parts = split(to_string(.file) ?? "", "/")
if length(parts) >= 6 {
  .tenant_id = parts[4]
  filename = parts[5] ?? ""
  .webroot_id = replace(filename, r'-access\.log$', "")
}
.log_type = "access"
.job = "nginx"

# Parse the JSON access log line
parsed, err = parse_json(.message)
if err == null {
  .message = to_string(parsed.method ?? "") + " " +
             to_string(parsed.uri ?? "") + " " +
             to_string(parsed.status ?? "")
  .structured = parsed
}
'''

# Per-tenant nginx error logs
[sources.tenant_error_logs]
type = "file"
include = ["/var/log/hosting/**/*-error.log"]
read_from = "end"
glob_minimum_cooldown_ms = 5000

[transforms.parse_tenant_error]
type = "remap"
inputs = ["tenant_error_logs"]
source = '''
parts = split(to_string(.file) ?? "", "/")
if length(parts) >= 6 {
  .tenant_id = parts[4]
  filename = parts[5] ?? ""
  .webroot_id = replace(filename, r'-error\.log$', "")
}
.log_type = "error"
.job = "nginx"
.level = "error"
'''

# PHP-FPM error logs
[sources.tenant_php_logs]
type = "file"
include = ["/var/log/hosting/*/php-error.log"]
read_from = "end"
glob_minimum_cooldown_ms = 5000

[transforms.parse_tenant_php]
type = "remap"
inputs = ["tenant_php_logs"]
source = '''
parts = split(to_string(.file) ?? "", "/")
if length(parts) >= 5 {
  .tenant_id = parts[4]
}
.log_type = "php-error"
.job = "php-fpm"
.level = "error"
'''

# PHP-FPM slow logs
[sources.tenant_php_slow]
type = "file"
include = ["/var/log/hosting/*/php-slow.log"]
read_from = "end"
glob_minimum_cooldown_ms = 5000
multiline.mode = "halt_before"
multiline.start_pattern = '^\[.+\] \[pool '
multiline.condition_pattern = '^\[.+\] \[pool '
multiline.timeout_ms = 1000

[transforms.parse_tenant_php_slow]
type = "remap"
inputs = ["tenant_php_slow"]
source = '''
parts = split(to_string(.file) ?? "", "/")
if length(parts) >= 5 {
  .tenant_id = parts[4]
}
.log_type = "php-slow"
.job = "php-fpm"
.level = "warn"
'''

# Runtime application logs (Node.js, Python, Ruby stdout/stderr)
[sources.tenant_app_logs]
type = "file"
include = ["/var/log/hosting/**/*-app.log"]
read_from = "end"
glob_minimum_cooldown_ms = 5000

[transforms.parse_tenant_app]
type = "remap"
inputs = ["tenant_app_logs"]
source = '''
parts = split(to_string(.file) ?? "", "/")
if length(parts) >= 6 {
  .tenant_id = parts[4]
  filename = parts[5] ?? ""
  .webroot_id = replace(filename, r'-app\.log$', "")
}
.log_type = "app"
.job = "runtime"
'''

# Cron job logs from journald (SyslogIdentifier = cron-{tenantName}-{cronJobID})
[sources.tenant_cron_logs]
type = "journald"
include_units = []
include_matches._SYSTEMD_UNIT = "cron-*.service"

[transforms.parse_tenant_cron]
type = "remap"
inputs = ["tenant_cron_logs"]
source = '''
# Extract tenant name and cron job ID from SYSLOG_IDENTIFIER: cron-{tenantName}-{cronJobID}
ident = to_string(.SYSLOG_IDENTIFIER) ?? ""
parts = split(ident, "-")
if length(parts) >= 3 {
  .tenant_id = parts[1]
  .cron_job_id = join!(slice!(parts, 2))
}
.log_type = "cron"
.job = "cron"

# Map systemd priority to level
priority = to_int(.PRIORITY) ?? 6
if priority <= 3 {
  .level = "error"
} else if priority <= 4 {
  .level = "warn"
} else {
  .level = "info"
}
'''

# Ship all tenant logs to TENANT Loki (port 3101, NOT platform Loki 3100)
[sinks.loki_tenant]
type = "loki"
inputs = [
  "parse_tenant_access",
  "parse_tenant_error",
  "parse_tenant_php",
  "parse_tenant_php_slow",
  "parse_tenant_app",
  "parse_tenant_cron",
]
endpoint = "{{ loki_tenant_endpoint }}"
encoding.codec = "text"

{% raw %}
[sinks.loki_tenant.labels]
job = "{{ job }}"
tenant_id = "{{ tenant_id }}"
webroot_id = "{{ webroot_id }}"
cron_job_id = "{{ cron_job_id }}"
log_type = "{{ log_type }}"
hostname = "{{ host }}"
level = "{{ level }}"
{% endraw %}
