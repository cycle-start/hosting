- name: Create hosting SSH groups
  group:
    name: "{{ item }}"
    state: present
    system: true
  loop:
    - hosting-ssh
    - hosting-sftp
    - hosting-noaccess

- name: Ensure sshd_config.d directory exists
  file:
    path: /etc/ssh/sshd_config.d
    state: directory
    mode: "0755"

- name: Deploy SSH hardening config
  copy:
    src: 00-hosting-base.conf
    dest: /etc/ssh/sshd_config.d/00-hosting-base.conf
    mode: "0644"
  notify: restart sshd

- name: Deploy SSH CA public key
  copy:
    content: "{{ ssh_ca_public_key }}"
    dest: /etc/ssh/hosting_ca.pub
    mode: "0644"
  when: ssh_ca_public_key is defined and ssh_ca_public_key | length > 0
  notify: restart sshd
