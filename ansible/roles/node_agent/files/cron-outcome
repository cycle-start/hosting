#!/bin/bash
# Called by ExecStopPost=+ (as root) after every cron job execution.
# Reports success/failure to core-api for auto-disable tracking.
# Exit code 75 = flock lock contention (job skipped) â€” don't report.
[ "$EXIT_STATUS" = "75" ] && exit 0
source /etc/default/node-agent 2>/dev/null
[ -z "$CORE_API_URL" ] && exit 0
if [ "$SERVICE_RESULT" = "success" ]; then
  SUCCESS="true"
else
  SUCCESS="false"
fi
curl -sf -X POST \
  -H "Authorization: Bearer $CORE_API_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{\"success\":$SUCCESS,\"exit_code\":$EXIT_STATUS,\"node_id\":\"$NODE_ID\"}" \
  "$CORE_API_URL/internal/v1/cron-jobs/$CRON_JOB_ID/outcome" \
  >/dev/null 2>&1 || true
